<!doctype html> 
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Model Sistem Dinamik Keterlambatan Pengiriman</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

  <div class="container main-container py-4 py-md-5">

    <!-- ðŸŽ¯ JUDUL DALAM TOMBOL (DIBESARKAN) -->
    <div class="text-center mb-4">
      <button class="btn-title-neon title-button">
        ðŸ“¦ Model Sistem Dinamik Keterlambatan Pengiriman Pada Layanan E-Commerce ðŸ“¦
      </button>
    </div>

    <!-- CARD FORM KONFIGURASI -->
    <div class="card card-glass shadow-lg p-4 border-0 rounded-4 mb-4">

      <h4 class="text-center text-light mb-2">Konfigurasi Simulasi</h4>
      <p class="text-center config-desc small mb-4">
        Atur parameter kapasitas pengiriman untuk melihat dampak terhadap
        <strong>backlog</strong> dan <strong>keterlambatan pengiriman</strong>
        berdasarkan data order historis.
      </p>

      <!-- 4 INPUT KIRI, 3 INPUT KANAN, TOMBOL DI BAWAH -->
      <form method="POST" class="row g-4 align-items-start">

        <!-- KIRI: 4 INPUT -->
        <div class="col-lg-6 col-md-6">
          <div class="mb-3">
            <label for="base_capacity" class="form-label text-light small">
              Kapasitas dasar / hari (paket)
            </label>
            <input id="base_capacity" type="number" step="0.1" min="1"
                   name="base_capacity"
                   class="form-control form-control-sm"
                   placeholder="min 1 paket (contoh: 30)"
                   value="{{ form.base_capacity }}" required>
            <div class="form-text text-muted small mt-1">
              Minimal <strong>1 paket/hari</strong>. Contoh: 30 (kemampuan kirim per hari).
            </div>
          </div>

          <div class="mb-3">
            <label for="backlog_threshold" class="form-label text-light small">
              Ambang backlog (adaptif)
            </label>
            <input id="backlog_threshold" type="number" min="0"
                   name="backlog_threshold"
                   class="form-control form-control-sm"
                   placeholder="min 0 paket (contoh: 150)"
                   value="{{ form.backlog_threshold }}">
            <div class="form-text text-muted small mt-1">
              Minimal <strong>0</strong>. Jika backlog &gt; nilai ini dan mode adaptif,
              kapasitas akan dinaikkan. Contoh: 150.
            </div>
          </div>

          <div class="mb-3">
            <label for="capacity_step" class="form-label text-light small">
              Kenaikan kapasitas / hari
            </label>
            <input id="capacity_step" type="number" min="0"
                   name="capacity_step"
                   class="form-control form-control-sm"
                   placeholder="min 0 paket (contoh: 15)"
                   value="{{ form.capacity_step }}">
            <div class="form-text text-muted small mt-1">
              Minimal <strong>0</strong>. Tambahan kapasitas per hari saat backlog melewati ambang.
              Contoh: 15 paket.
            </div>
          </div>

          <div class="mb-0">
            <label for="initial_backlog" class="form-label text-light small">
              Backlog awal
            </label>
            <input id="initial_backlog" type="number" min="0"
                   name="initial_backlog"
                   class="form-control form-control-sm"
                   placeholder="min 0 paket (contoh: 0 atau 50)"
                   value="{{ form.initial_backlog }}">
            <div class="form-text text-muted small mt-1">
              Minimal <strong>0</strong>. Isi &gt; 0 jika ingin simulasi dimulai dari
              kondisi sudah tertunda. Contoh: 50.
            </div>
          </div>
        </div>

        <!-- KANAN: 3 INPUT -->
        <div class="col-lg-6 col-md-6">
          <div class="mb-3">
            <label for="policy" class="form-label text-light small">
              Kebijakan kapasitas
            </label>
            <select id="policy" name="policy"
                    class="form-select form-select-sm">
              <option value="constant"
                      {% if form.policy == 'constant' %}selected{% endif %}>
                Konstan
              </option>
              <option value="adaptive"
                      {% if form.policy == 'adaptive' %}selected{% endif %}>
                Adaptif (naik jika backlog tinggi)
              </option>
            </select>
            <div class="form-text text-muted small mt-1">
              <strong>Konstan</strong> = kapasitas tetap. <strong>Adaptif</strong> = kapasitas naik
              jika backlog melewati ambang.
            </div>
          </div>

          <div class="mb-3">
            <label for="max_capacity_multiplier" class="form-label text-light small">
              Maks. kapasitas (Ã— rata-rata)
            </label>
            <input id="max_capacity_multiplier" type="number" step="0.1" min="0.1"
                   name="max_capacity_multiplier"
                   class="form-control form-control-sm"
                   placeholder="min 0,1 (contoh: 2,0)"
                   value="{{ form.max_capacity_multiplier }}">
            <div class="form-text text-muted small mt-1">
              Minimal <strong>0,1</strong>. Misal 2,0 berarti kapasitas maksimum = 2Ã— rata-rata
              order per hari.
            </div>
          </div>

          <div class="mb-0">
            <label for="num_days_show" class="form-label text-light small">
              Jumlah hari ditampilkan di tabel
            </label>
            <input id="num_days_show" type="number" min="1"
                   max="{{ orders_chart.dates|length }}"
                   name="num_days_show"
                   class="form-control form-control-sm"
                   placeholder="1â€“{{ orders_chart.dates|length }} hari"
                   value="{{ form.num_days_show }}">
            <div class="form-text text-muted small mt-1">
              Minimal <strong>1 hari</strong>, maksimal
              <strong>{{ orders_chart.dates|length }} hari</strong> (sesuai panjang data).
            </div>
          </div>
        </div>

        <!-- TOMBOL DI BAWAH KEDUA KOLOM -->
        <div class="col-12 d-flex justify-content-center mt-5">
          <button type="submit" class="btn btn-primary btn-lg px-5 btn-run">
            Jalankan Simulasi
          </button>
        </div>

      </form>

    </div>
    <!-- END CARD FORM -->

    {% if results %}

    <!-- CARD HASIL SIMULASI -->
    <div class="card card-glass shadow-lg p-4 border-0 rounded-4 mb-4">
      <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
        <div>
          <h4 class="text-light mb-1">Hasil Simulasi</h4>
          <p class="text-muted small mb-0">
            Menampilkan {{ results.num_days_show }} hari pertama berdasarkan pola order historis.
          </p>
        </div>
        <div class="text-end small text-light">
          Mode kapasitas:
          {% if form.policy == 'constant' %}
            <span class="badge bg-secondary ms-1">Konstan</span>
          {% else %}
            <span class="badge bg-success ms-1">Adaptif</span>
          {% endif %}
        </div>
      </div>

      <div class="table-responsive rounded-3 border border-secondary-subtle bg-table">
        <table class="table table-sm table-hover mb-0 align-middle text-light text-center">
          <thead class="table-dark">
            <tr>
              <th scope="col" class="text-center">Tanggal</th>
              <th scope="col" class="text-center">Order</th>
              <th scope="col" class="text-center">Kapasitas</th>
              <th scope="col" class="text-center">Delivery Rate</th>
              <th scope="col" class="text-center">Backlog</th>
              <th scope="col" class="text-center">Delay (hari)</th>
            </tr>
          </thead>
          <tbody>
          {% for row in results.rows %}
            <tr>
              <td class="text-center small">{{ row.day }}</td>
              <td class="text-center">{{ "%.0f"|format(row.order) }}</td>
              <td class="text-center">{{ "%.2f"|format(row.capacity) }}</td>
              <td class="text-center">{{ "%.2f"|format(row.delivery_rate) }}</td>
              <td class="text-center">{{ "%.2f"|format(row.backlog) }}</td>
              <td class="text-center">{{ "%.2f"|format(row.delay) }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>

      <p class="text-muted small mt-4 mb-0">
        Backlog tinggi mengindikasikan penumpukan pesanan yang belum terkirim.
        Semakin besar backlog terhadap kapasitas, semakin besar estimasi delay rata-rata.
      </p>
    </div>
    <!-- END CARD HASIL -->

    <!-- CARD GRAFIK -->
    <div class="card card-glass shadow-lg p-4 border-0 rounded-4 mb-4 text-center">
      <h4 class="text-light mb-3">ðŸ“ˆ Grafik Sistem Dinamik Pengiriman</h4>

      <div class="row g-4">
        <!-- Grafik order per hari -->
        <div class="col-md-4">
          <h6 class="text-light mb-2">Order per Hari</h6>
          <div class="ratio ratio-16x9 chart-frame">
            <div id="ordersChart"></div>
          </div>
          <div id="ordersInfo" class="chart-info small mt-2"></div>
        </div>

        {% if sim_chart %}
        <!-- Grafik backlog -->
        <div class="col-md-4">
          <h6 class="text-light mb-2">Backlog vs Waktu</h6>
          <div class="ratio ratio-16x9 chart-frame">
            <div id="backlogChart"></div>
          </div>
          <div id="backlogInfo" class="chart-info small mt-2"></div>
        </div>

        <!-- Grafik delay -->
        <div class="col-md-4">
          <h6 class="text-light mb-2">Delay vs Waktu</h6>
          <div class="ratio ratio-16x9 chart-frame">
            <div id="delayChart"></div>
          </div>
          <div id="delayInfo" class="chart-info small mt-2"></div>
        </div>
        {% endif %}
      </div>
    </div>
    <!-- END CARD GRAFIK -->

    {% endif %}

    <footer class="text-center mt-3 text-muted small">
      Â© {{ summary.date_max.year }} | Simulasi Sistem Dinamik Keterlambatan Pengiriman E-Commerce
    </footer>

  </div>

  {% if results %}
  <!-- Plotly JS hanya dipanggil kalau sudah ada hasil -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <script>
    // Data dari Flask
    const ordersDates  = {{ orders_chart.dates  | tojson }};
    const ordersValues = {{ orders_chart.orders | tojson }};

    {% if sim_chart %}
      const simDates       = {{ sim_chart.dates   | tojson }};
      const backlogValues  = {{ sim_chart.backlog| tojson }};
      const delayValues    = {{ sim_chart.delay  | tojson }};
    {% endif %}

    // ===== Grafik Order per Hari =====
    const ordersTrace = {
      x: ordersDates,
      y: ordersValues,
      type: "scatter",
      mode: "lines+markers",
      marker: { size: 6 },
      line: { shape: "linear" },
      hovertemplate: "Tanggal: %{x}<br>Order: %{y:.0f}<extra></extra>"
    };

    const commonLayout = {
      paper_bgcolor: "rgba(0,0,0,0)",
      plot_bgcolor: "rgba(0,0,0,0)",
      margin: { l: 40, r: 10, t: 10, b: 35 },
      font: { color: "#e5e7eb", size: 11 },
      xaxis: { tickangle: -35 }
    };

    Plotly.newPlot("ordersChart", [ordersTrace], {
      ...commonLayout,
      yaxis: { title: "Order" }
    }, {displaylogo: false, responsive: true});

    const ordersInfo = document.getElementById("ordersInfo");
    const ordersChartDiv = document.getElementById("ordersChart");
    ordersChartDiv.on("plotly_click", function(data) {
      const pt = data.points[0];
      ordersInfo.textContent = `Tanggal: ${pt.x} | Order: ${pt.y.toFixed(0)} paket`;
    });

    {% if sim_chart %}
    // ===== Grafik Backlog =====
    const backlogTrace = {
      x: simDates,
      y: backlogValues,
      type: "scatter",
      mode: "lines+markers",
      marker: { size: 6 },
      hovertemplate: "Tanggal: %{x}<br>Backlog: %{y:.2f}<extra></extra>"
    };

    Plotly.newPlot("backlogChart", [backlogTrace], {
      ...commonLayout,
      yaxis: { title: "Backlog" }
    }, {displaylogo: false, responsive: true});

    const backlogInfo = document.getElementById("backlogInfo");
    const backlogChartDiv = document.getElementById("backlogChart");
    backlogChartDiv.on("plotly_click", function(data) {
      const pt = data.points[0];
      backlogInfo.textContent = `Tanggal: ${pt.x} | Backlog: ${pt.y.toFixed(2)} paket`;
    });

    // ===== Grafik Delay =====
    const delayTrace = {
      x: simDates,
      y: delayValues,
      type: "scatter",
      mode: "lines+markers",
      marker: { size: 6 },
      hovertemplate: "Tanggal: %{x}<br>Delay: %{y:.2f} hari<extra></extra>"
    };

    Plotly.newPlot("delayChart", [delayTrace], {
      ...commonLayout,
      yaxis: { title: "Delay (hari)" }
    }, {displaylogo: false, responsive: true});

    const delayInfo = document.getElementById("delayInfo");
    const delayChartDiv = document.getElementById("delayChart");
    delayChartDiv.on("plotly_click", function(data) {
      const pt = data.points[0];
      delayInfo.textContent = `Tanggal: ${pt.x} | Delay: ${pt.y.toFixed(2)} hari`;
    });
    {% endif %}
  </script>
  {% endif %}

</body>
</html>
